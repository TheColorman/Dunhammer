<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Redirecting...</title>
    </head>
    <body>
        Redirecting...
        <script>
            (async () => {
                function getCookie(cname) { //https://www.w3schools.com/js/js_cookies.asp
                    var name = cname + "=";
                    var decodedCookie = decodeURIComponent(document.cookie);
                    var ca = decodedCookie.split(";");
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == " ") {
                            c = c.substring(1);
                        }
                        if (c.indexOf(name) == 0) {
                            return c.substring(name.length, c.length);
                        }
                    }
                    return "";
                }

                const urlSearchParams = new URLSearchParams(
                    window.location.search
                );
                const params = Object.fromEntries(urlSearchParams.entries());

                const savedState = getCookie("state");
                const returnedState = params.state;
                if (savedState !== returnedState) {
                    return window.location.href = "/unsecure";
                }
                document.cookie = "state=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                const res = await fetch(`/api/discord/verify`, {
                    method: "POST",
                    body: JSON.stringify({ 
                        code: params.code,
                        redirect_uri: `${location.protocol}//${location.host}${location.pathname}`
                    }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                if (res.ok) {
                    document.location.href = "/";
                }
            })();
        </script>
    </body>
</html>
